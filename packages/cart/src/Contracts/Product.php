<?php

namespace Antidote\LaravelCart\Contracts;

use Antidote\LaravelCart\Concerns\ConfiguresProduct;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\MorphTo;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Support\Str;

abstract class Product extends Model
{
    use ConfiguresProduct;

    /**
     * @var array array of attributes that should be obtained from the Product Data Type
     */
    protected array $product_data = [];

    /**
     * @var array array of Product Data Type classes where validity should be checked. The Product Data Type should provide the method `isValid` returning a boolean
     */
    protected array $product_validity = [];

    public function productType() : MorphTo
    {
        return $this->morphTo()->withTrashed();
    }

    protected static function booted()
    {
        static::deleted(function ($product) {

            $product->productType->delete();
        });

        //@see https://stackoverflow.com/a/63902244
        if(in_array(SoftDeletes::class, class_uses_recursive(static::class))) {

            static::restored(function ($product) {

                $product->productType->restore();

            });

        }

        static::forceDeleted(function ($product) {

            $product->productType->forceDelete();
        });
    }

    public function __call($method, $parameters)
    {
        if($method == 'checkValidity') {
            if(in_array(get_class($this->productType), $this->product_validity )) {
                return $this->productType->isValid(...$parameters);
            } else {
                return $this->isValid(...$parameters);
            }
        }

        $product_methods = collect($this->product_data)
            ->map(fn($product_data) => 'get' . Str::studly($product_data))
            ->toArray();

        if(in_array($method, $product_methods)) {
            //defer to product data type
            if(method_exists($this->productType, $method )) {
                return $this->productType->$method(...$parameters);
            } else {
                throw new \Exception("Define '{$method}' on ".get_class($this->productType));
            }
        }

        return parent::__call($method,$parameters); // TODO: Change the autogenerated stub
    }
}
